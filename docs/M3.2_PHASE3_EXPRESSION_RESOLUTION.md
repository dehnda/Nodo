# M3.2 Phase 3: Expression Resolution in ExecutionEngine

## Overview
Integrated graph parameter expression resolution into the ExecutionEngine, enabling node parameters to reference graph-level parameters using expressions like `$param_name`.

## Changes Made

### 1. execution_engine.cpp - Added Include
```cpp
#include "nodo/graph/parameter_expression_resolver.hpp"
```

### 2. execution_engine.hpp - Updated Method Signature
**Before:**
```cpp
void transfer_parameters(const GraphNode &graph_node, sop::SOPNode &sop_node);
```

**After:**
```cpp
void transfer_parameters(const GraphNode &graph_node, sop::SOPNode &sop_node,
                        const NodeGraph &graph);
```

Added `graph` parameter to enable access to graph parameters for expression resolution.

### 3. execution_engine.cpp - Updated Implementation

**Key changes in `transfer_parameters`:**

1. **Create Resolver**: Instantiate `ParameterExpressionResolver` with access to the node graph
   ```cpp
   ParameterExpressionResolver resolver(graph);
   ```

2. **String Parameter Resolution**: Check for parameter references and resolve them
   ```cpp
   case NodeParameter::Type::String:
   case NodeParameter::Type::Code: {
     if (resolver.has_references(param.string_value)) {
       std::string resolved = resolver.resolve(param.string_value);
       sop_node.set_parameter(param.name, resolved);
     } else {
       sop_node.set_parameter(param.name, param.string_value);
     }
     break;
   }
   ```

3. **Updated Call Site**: Pass graph to transfer_parameters
   ```cpp
   transfer_parameters(*node, *sop, graph);
   ```

## How It Works

### Expression Syntax
Users can reference graph parameters in node string parameters using:
- `$param_name` - Direct reference
- `@param_name` - Alternative syntax
- `${param_name}` - Explicit braces for complex expressions

### Resolution Flow
1. User creates graph parameter (e.g., "global_seed" = 42)
2. User enters expression in node parameter (e.g., `$global_seed`)
3. ExecutionEngine calls `transfer_parameters` before cooking node
4. Resolver detects `$global_seed` reference
5. Resolver looks up "global_seed" in graph parameters
6. Resolver replaces `$global_seed` with "42"
7. Resolved value "42" is passed to SOP node

### Supported Parameter Types
Currently, expression resolution works for:
- ‚úÖ **String parameters**: Full support with `$param` syntax
- ‚úÖ **Code parameters**: Full support (VEX expressions can reference parameters)
- ‚è≥ **Numeric parameters**: TODO - Requires UI support for text input on numeric fields

### Type Conversion
The resolver automatically converts parameter types:
- Int ‚Üí string representation ("42")
- Float ‚Üí string with 3 decimal places ("1.500")
- Bool ‚Üí "1" or "0"
- String ‚Üí direct value
- Vector3 ‚Üí formatted as "(x, y, z)"

### Error Handling
- **Missing parameter**: Expression left unchanged (e.g., `$nonexistent` stays as-is)
- **Invalid syntax**: Passed through unchanged
- **Type mismatch**: Automatic conversion applied

## Testing

### Test Graph Created
`projects/test_graph_parameters.nfg` demonstrates:
- Graph parameters: global_seed (Int), base_radius (Float), object_name (String)
- Single sphere node with parameters ready for expression testing

### Manual Testing Steps
1. Open test graph in Nodo Studio
2. Open Graph Parameters panel
3. Modify parameter values
4. Observe that string fields can use `$param` syntax
5. Changes to graph parameters trigger re-execution

### Example Use Cases

**Case 1: Shared Random Seed**
```
Graph Parameter: seed = 42
Scatter Node 1: seed = "$seed"  ‚Üí Resolves to "42"
Scatter Node 2: seed = "$seed"  ‚Üí Resolves to "42"
```
Changing graph-level seed updates all scatter nodes.

**Case 2: Named Objects**
```
Graph Parameter: project_name = "Demo"
Export Node: filename = "$project_name_output.obj"  ‚Üí Resolves to "Demo_output.obj"
```

**Case 3: VEX Expressions**
```
Graph Parameter: multiplier = 2.5
Wrangle Node: code = "P.y *= $multiplier;"  ‚Üí Resolves to "P.y *= 2.5;"
```

## Current Limitations

### 1. Numeric Fields Don't Support Text Input
**Issue**: UI widgets for Int/Float/Vector3 use sliders/spinboxes, not text fields
**Impact**: Can't type `$param` expressions in numeric parameters yet
**Workaround**: Use string parameters or VEX code for expressions
**Future**: Add optional text input mode for numeric parameters

### 2. No Visual Feedback
**Issue**: No indication in UI when parameter contains expression
**Impact**: Hard to tell which fields are using graph parameters
**Future**: Add icon/color indicator for expression-enabled fields

### 3. No Auto-Complete
**Issue**: Must manually type parameter names
**Impact**: Typos lead to unresolved expressions
**Future**: Ctrl+Space auto-complete with available parameters

### 4. No Expression Validation
**Issue**: Invalid parameter references silently fail
**Impact**: User doesn't know expression didn't resolve
**Future**: Show warning icon for unresolved references

### 5. String-Only Resolution
**Issue**: Numeric parameters are passed as numeric values, not strings
**Impact**: Can't do arithmetic expressions like `$radius * 2` yet
**Future**: Requires expression parser/evaluator for math

## Next Steps

### Immediate (Required for M3.2 Completion)
1. ‚úÖ Expression resolution in ExecutionEngine (DONE)
2. üîÑ Add visual indicators to PropertyPanel (IN PROGRESS)
3. ‚è≥ Test with real graphs
4. ‚è≥ Documentation and examples

### Short-term (M3.3 Polish)
1. Auto-complete for parameter names
2. Validation warnings for invalid references
3. Expression preview/tooltip showing resolved value
4. Better error messages

### Medium-term (M3.4+)
1. Arithmetic expressions: `$radius * 2 + 1`
2. Text input mode for numeric parameters
3. Expression builder UI dialog
4. Parameter dependencies graph

### Long-term (M3.5 Subgraphs)
1. Hierarchical parameters: `$parent.param`
2. Subgraph parameter inheritance
3. Parameter scoping and namespaces
4. Parameter promotion to parent graphs

## Technical Notes

### Performance
- Expression resolution happens once per node per cook
- Resolution is fast (regex + map lookup)
- Cached geometry prevents unnecessary re-resolution
- No measurable performance impact

### Thread Safety
- Resolver created per execution (no shared state)
- NodeGraph is const during resolution (read-only)
- Safe for future async execution

### Forward Compatibility
- Parameter name validation already prevents dots (reserved for `$parent.param`)
- Expression syntax extensible to more complex patterns
- Type system ready for arithmetic expressions

## Build Status
‚úÖ nodo_core compiles successfully
‚úÖ nodo_studio compiles successfully
‚úÖ No new warnings introduced
‚úÖ All tests pass (existing test suite)

## Files Modified
- `/home/daniel/projects/Nodo/nodo_core/include/nodo/graph/execution_engine.hpp`
- `/home/daniel/projects/Nodo/nodo_core/src/graph/execution_engine.cpp`

## Files Created
- `/home/daniel/projects/Nodo/projects/test_graph_parameters.nfg` (test graph)
- `/home/daniel/projects/Nodo/docs/M3.2_PHASE3_EXPRESSION_RESOLUTION.md` (this document)
