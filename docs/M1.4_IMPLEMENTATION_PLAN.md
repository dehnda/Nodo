# M1.4 Implementation Plan
**Date:** November 1, 2025
**Goal:** Implement missing nodes and fix incomplete ones for 40-node complete system

---

## Duplicates Removed (4 nodes)

‚úÖ **Join** ‚Üí Use Merge instead (identical functionality)
‚úÖ **Displace** ‚Üí Noise Displacement covers this (can add attribute mode later)
‚úÖ **Separate** ‚Üí Use Blast to delete groups (achieves separation)
‚úÖ **Group Delete** ‚Üí Not needed (deleting group metadata vs geometry)

**New Total: 40 nodes** (down from 44)

---

## Implementation Priority

### üî¥ CRITICAL - Blocking M1.4 Testing (3 nodes, ~4-6 hours)

#### 1. Line SOP üîß
**Status:** Header-only stub, no implementation
**Location:** `nodo_core/include/nodo/sop/line_sop.hpp`
**Why critical:** Generator node, needed for basic workflows

**Implementation tasks:**
```cpp
// In line_sop.hpp constructor:
explicit LineSOP(const std::string &name = "line") : SOPNode(name, "Line") {

  // Primitive type
  register_parameter(define_int_parameter("primitive_type", 0)
    .label("Primitive Type")
    .options({"Line", "Points"})
    .category("Universal")
    .build());

  // Start point
  register_parameter(define_vector3_parameter("origin", {0.0F, 0.0F, 0.0F})
    .label("Origin")
    .category("Geometry")
    .description("Start point of the line")
    .build());

  // End point OR direction + length
  register_parameter(define_int_parameter("end_mode", 0)
    .label("End Mode")
    .options({"Point", "Direction + Length"})
    .category("Geometry")
    .build());

  register_parameter(define_vector3_parameter("end", {1.0F, 0.0F, 0.0F})
    .label("End")
    .category("Geometry")
    .visible_when("end_mode", 0)
    .description("End point of the line")
    .build());

  register_parameter(define_vector3_parameter("direction", {1.0F, 0.0F, 0.0F})
    .label("Direction")
    .category("Geometry")
    .visible_when("end_mode", 1)
    .description("Direction vector")
    .build());

  register_parameter(define_float_parameter("length", 1.0F)
    .label("Length")
    .range(0.01F, 100.0F)
    .category("Geometry")
    .visible_when("end_mode", 1)
    .build());

  // Points along line
  register_parameter(define_int_parameter("points", 2)
    .label("Points")
    .range(2, 1000)
    .category("Resolution")
    .description("Number of points along the line")
    .build());
}
```

**Execute implementation:**
- Create points along line from origin to end
- If mode=Point: interpolate between origin and end
- If mode=Direction: interpolate along direction * length
- Handle primitive_type (Line = edges, Points = point cloud)

**Estimated time:** 2-3 hours

---

#### 2. Extrude SOP ‚ö†Ô∏è
**Status:** Has implementation but uses private members instead of parameters
**Location:** `nodo_core/include/nodo/sop/extrude_sop.hpp`
**Why critical:** Core modeling operation

**Problem:** Currently has:
```cpp
private:
  double distance_ = 1.0;
  Eigen::Vector3d direction_{0.0, 0.0, 1.0};
  ExtrusionMode mode_ = ExtrusionMode::FACE_NORMALS;
  double inset_ = 0.0;
```

**Fix:** Replace with registered parameters in constructor:
```cpp
explicit ExtrudeSOP(const std::string &name = "extrude") : SOPNode(name, "Extrude") {
  input_ports_.add_port("0", NodePort::Type::INPUT, NodePort::DataType::GEOMETRY, this);

  register_parameter(define_int_parameter("mode", 0)
    .label("Mode")
    .options({"Face Normals", "Uniform Direction", "Region Normals"})
    .category("Extrusion")
    .description("How to calculate extrusion direction")
    .build());

  register_parameter(define_float_parameter("distance", 1.0F)
    .label("Distance")
    .range(-10.0F, 10.0F)
    .category("Extrusion")
    .description("Extrusion distance (negative = inward)")
    .build());

  register_parameter(define_vector3_parameter("direction", {0.0F, 0.0F, 1.0F})
    .label("Direction")
    .category("Direction")
    .visible_when("mode", 1) // Only for Uniform Direction mode
    .description("Uniform extrusion direction")
    .build());

  register_parameter(define_float_parameter("inset", 0.0F)
    .label("Inset")
    .range(0.0F, 1.0F)
    .category("Extrusion")
    .description("Inset amount for border around extruded faces")
    .build());
}
```

**Update execute():** Read from parameters instead of member variables:
```cpp
const auto mode = static_cast<ExtrusionMode>(get_parameter<int>("mode", 0));
const auto distance = get_parameter<float>("distance", 1.0F);
const auto direction = get_parameter<Eigen::Vector3f>("direction", {0, 0, 1});
const auto inset = get_parameter<float>("inset", 0.0F);
```

**Estimated time:** 1-2 hours

---

#### 3. Subdivision SOP ‚ö†Ô∏è
**Status:** Has setters but unclear if parameters are registered
**Location:** `nodo_core/include/nodo/sop/subdivisions_sop.hpp`
**Why critical:** Core smoothing operation

**Verify these are registered in constructor:**
```cpp
explicit SubdivisionSOP(const std::string &name = "subdivision") : SOPNode(name, "Subdivision") {
  input_ports_.add_port("0", NodePort::Type::INPUT, NodePort::DataType::GEOMETRY, this);

  register_parameter(define_int_parameter("subdivision_levels", 1)
    .label("Subdivision Levels")
    .range(0, 5)
    .category("Subdivision")
    .description("Number of subdivision iterations (0-5)")
    .build());

  register_parameter(define_bool_parameter("preserve_boundaries", true)
    .label("Preserve Boundaries")
    .category("Subdivision")
    .description("Keep boundary edges sharp")
    .build());
}
```

**If missing:** Add parameters and update execute() to read from them.

**Estimated time:** 1 hour

---

### üü° HIGH PRIORITY - Missing Functionality (4 nodes, ~8-12 hours)

#### 4. Attribute Delete SOP ‚ö†Ô∏è
**Status:** Unknown if exists
**Location:** `nodo_core/include/nodo/sop/attribute_delete_sop.hpp`

**Implementation:**
```cpp
explicit AttributeDeleteSOP(const std::string &name = "attribdelete")
  : SOPNode(name, "AttributeDelete") {

  input_ports_.add_port("0", NodePort::Type::INPUT, NodePort::DataType::GEOMETRY, this);

  register_parameter(define_string_parameter("name", "")
    .label("Attribute Name")
    .category("Attribute")
    .description("Name of attribute to delete (or pattern with *)")
    .build());

  add_class_parameter(); // Point/Primitive/Vertex/Detail

  register_parameter(define_bool_parameter("use_pattern", false)
    .label("Use Pattern")
    .category("Attribute")
    .description("Enable wildcard matching (* and ?)")
    .build());
}
```

**Execute:**
- Get attribute name/pattern
- Get class
- If use_pattern: match with wildcards
- Delete matching attributes from geometry

**Estimated time:** 2-3 hours

---

#### 5. Color SOP ‚ö†Ô∏è
**Status:** Unknown if exists
**Location:** `nodo_core/include/nodo/sop/color_sop.hpp`

**Implementation:**
```cpp
explicit ColorSOP(const std::string &name = "color") : SOPNode(name, "Color") {
  input_ports_.add_port("0", NodePort::Type::INPUT, NodePort::DataType::GEOMETRY, this);

  add_class_parameter(); // Point/Primitive/Vertex/Detail

  register_parameter(define_int_parameter("color_mode", 0)
    .label("Color Mode")
    .options({"Constant", "Random", "From Attribute"})
    .category("Color")
    .build());

  // Constant mode
  register_parameter(define_vector3_parameter("color", {1.0F, 1.0F, 1.0F})
    .label("Color")
    .range(0.0F, 1.0F)
    .category("Color")
    .visible_when("color_mode", 0)
    .description("RGB color (0-1 range)")
    .build());

  // Random mode
  register_parameter(define_int_parameter("seed", 42)
    .label("Seed")
    .category("Color")
    .visible_when("color_mode", 1)
    .description("Random seed")
    .build());

  // From attribute mode
  register_parameter(define_string_parameter("attribute", "N")
    .label("Attribute")
    .category("Color")
    .visible_when("color_mode", 2)
    .description("Attribute name to use as color (remapped to 0-1)")
    .build());
}
```

**Execute:**
- Create/update "Cd" (color) attribute
- Mode 0: Set all to constant color
- Mode 1: Random colors per element (seeded)
- Mode 2: Remap attribute values to color

**Estimated time:** 3-4 hours

---

#### 6. Sort SOP ‚ö†Ô∏è
**Status:** Unknown if exists
**Location:** `nodo_core/include/nodo/sop/sort_sop.hpp`

**Implementation:**
```cpp
explicit SortSOP(const std::string &name = "sort") : SOPNode(name, "Sort") {
  input_ports_.add_port("0", NodePort::Type::INPUT, NodePort::DataType::GEOMETRY, this);

  add_class_parameter(); // Point/Primitive/Vertex

  register_parameter(define_int_parameter("sort_by", 0)
    .label("Sort By")
    .options({"X", "Y", "Z", "Attribute", "Reverse", "Random"})
    .category("Sort")
    .build());

  register_parameter(define_string_parameter("attribute", "")
    .label("Attribute")
    .category("Sort")
    .visible_when("sort_by", 3)
    .description("Attribute name to sort by")
    .build());

  register_parameter(define_int_parameter("seed", 42)
    .label("Seed")
    .category("Sort")
    .visible_when("sort_by", 5)
    .description("Random seed for shuffle")
    .build());
}
```

**Execute:**
- Get sort order
- Reorder points/primitives based on criteria
- Update topology indices

**Estimated time:** 2-3 hours

---

#### 7. Smooth/Laplacian SOP ‚ö†Ô∏è
**Status:** Needs verification
**Location:** `nodo_core/include/nodo/sop/laplacian_sop.hpp`

**Verify parameters registered:**
```cpp
register_parameter(define_int_parameter("method", 0)
  .label("Method")
  .options({"Uniform", "Cotangent", "Taubin"})
  .category("Smoothing")
  .build());

register_parameter(define_int_parameter("iterations", 5)
  .label("Iterations")
  .range(1, 100)
  .category("Smoothing")
  .build());

register_parameter(define_float_parameter("lambda", 0.5F)
  .label("Lambda")
  .range(0.0F, 1.0F)
  .category("Smoothing")
  .description("Smoothing strength")
  .build());

register_parameter(define_float_parameter("mu", -0.53F)
  .label("Mu")
  .range(-1.0F, 0.0F)
  .category("Smoothing")
  .visible_when("method", 2) // Only for Taubin
  .description("Negative smoothing to prevent shrinkage")
  .build());
```

**Estimated time:** 1 hour

---

### üü¢ MEDIUM PRIORITY - Advanced Features (6 nodes, ~12-18 hours)

#### 8. Bevel SOP ‚ùå
**Status:** Not implemented
**Complexity:** High (edge detection, topology changes)

**Decision:** Implement basic version or defer to Phase 2?
- If implement: Need edge detection, face offsetting, side face generation
- If defer: Users can approximate with Subdivide + Scale

**Estimated time:** 6-8 hours (complex)

---

#### 9. Align SOP ‚ùå
**Status:** Not implemented

**Implementation:**
- Align to world axes (center to origin)
- Align to bounding box (min/max/center)
- Align to another geometry

**Estimated time:** 2-3 hours

---

#### 10. Split SOP ‚ùå
**Status:** Not implemented

**Implementation:**
- Separate by connectivity (disconnected pieces)
- Split by attribute value
- Each piece becomes separate primitive

**Estimated time:** 3-4 hours

---

#### 11. Remesh SOP ‚ùå
**Status:** Not implemented
**Complexity:** High (requires remeshing algorithm)

**Decision:** Defer to Phase 2 unless critical.
- Requires isotropic remeshing algorithm
- More of a mesh optimization tool

**Estimated time:** 8-10 hours (very complex)

---

#### 12-16. Advanced Group Operations ‚ö†Ô∏è
**Status:** Unknown if exist

- **Group Promote** - Convert point‚Üîprimitive groups (2h)
- **Group Combine** - Boolean operations on groups (2h)
- **Group Expand** - Grow/shrink by iterations (2-3h)
- **Group Transfer** - Transfer between geometries (3h)

**Total estimated:** 9-10 hours

---

### üîµ LOW PRIORITY - Optional/Deferred (3 nodes)

#### 17. Lattice SOP ‚ö†Ô∏è
**Status:** Partially implemented, needs deformation logic
**Decision:** Simplify to lattice visualization only, defer deformation

**Estimated time:** 0 hours (use as-is) or 6-8 hours (full deformation)

---

#### 18-20. Deferred to Phase 2
- **Cache SOP** - Performance optimization (Phase 2)
- **Time SOP** - Animation system needed (Phase 2)
- **Subnetwork SOP** - Complex feature (Phase 3)

---

## Implementation Order Recommendation

### Week 1: Critical Blockers (16-22 hours)
1. Line SOP (2-3h) ‚úÖ Enables generator testing
2. Extrude SOP fix (1-2h) ‚úÖ Core modeling
3. Subdivision SOP verify (1h) ‚úÖ Core modeling
4. Attribute Delete (2-3h) ‚úÖ Attribute workflow
5. Color SOP (3-4h) ‚úÖ Visualization
6. Sort SOP (2-3h) ‚úÖ Workflow utility
7. Laplacian verify (1h) ‚úÖ Smoothing

**Deliverable:** 33/40 nodes working (83%)

### Week 2: Advanced Features (Optional, 21-28 hours)
8. Align SOP (2-3h)
9. Split SOP (3-4h)
10. Group Promote (2h)
11. Group Combine (2h)
12. Group Expand (2-3h)
13. Group Transfer (3h)
14. Bevel SOP (6-8h) - if time permits

**Deliverable:** 37-40/40 nodes working (93-100%)

### Week 3: Testing & Polish
- Systematic testing following M1.4 checklist
- Bug fixes
- Documentation
- Example scenes

---

## Files to Create/Modify

### New Files Needed:
- `nodo_core/src/sop/line_sop.cpp`
- `nodo_core/include/nodo/sop/attribute_delete_sop.hpp` (if missing)
- `nodo_core/src/sop/attribute_delete_sop.cpp` (if missing)
- `nodo_core/include/nodo/sop/color_sop.hpp` (if missing)
- `nodo_core/src/sop/color_sop.cpp` (if missing)
- `nodo_core/include/nodo/sop/sort_sop.hpp` (if missing)
- `nodo_core/src/sop/sort_sop.cpp` (if missing)

### Files to Modify:
- `nodo_core/include/nodo/sop/extrude_sop.hpp` - Add parameters
- `nodo_core/src/sop/extrude_sop.cpp` - Read from parameters
- `nodo_core/include/nodo/sop/subdivisions_sop.hpp` - Verify parameters
- `nodo_core/include/nodo/sop/laplacian_sop.hpp` - Verify parameters
- `nodo_core/src/sop/sop_factory.cpp` - Update metadata for new nodes

### CMakeLists Updates:
- Add new .cpp files to `nodo_core/CMakeLists.txt`

---

## Success Criteria

### Minimum (33 nodes, Week 1):
- ‚úÖ All generator nodes working (6)
- ‚úÖ Core modifiers working (5)
- ‚úÖ All transform nodes working (6)
- ‚úÖ Boolean/merge working (2)
- ‚úÖ Core attribute ops working (6)
- ‚úÖ Basic group ops working (3)
- ‚úÖ All utility nodes working (5)

### Target (37 nodes, Week 2):
- ‚úÖ + Align SOP
- ‚úÖ + Split SOP
- ‚úÖ + 4 advanced group operations

### Stretch (40 nodes, Week 2+):
- ‚úÖ + Bevel SOP
- ‚úÖ + Remesh SOP (if really needed)

---

## Next Actions

1. ‚úÖ **Remove duplicates from codebase** (if headers exist)
2. ‚úÖ **Start with Line SOP** (most straightforward)
3. ‚úÖ **Fix Extrude SOP** (quick refactor)
4. ‚úÖ **Verify Subdivision/Laplacian** (might already work)
5. ‚úÖ **Implement missing utility nodes** (Delete, Color, Sort)
6. **Decide on advanced features** (Bevel, Remesh, group ops)

Ready to start implementing?
