name: Release

on:
  push:
    tags:
      - 'v*'  # Triggers on tags like v0.1.0, v1.0.0, etc.

jobs:
  build-linux:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            pkg-config \
            python3-pip \
            qt6-base-dev \
            libqt6svg6-dev \
            libqt6concurrent6 \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libx11-dev \
            libxext-dev \
            libxfixes-dev \
            libxi-dev \
            libxrender-dev \
            libxcb1-dev \
            libxcb-glx0-dev \
            libxcb-keysyms1-dev \
            libxcb-image0-dev \
            libxcb-shm0-dev \
            libxcb-icccm4-dev \
            libxcb-sync-dev \
            libxcb-xfixes0-dev \
            libxcb-shape0-dev \
            libxcb-randr0-dev \
            libxcb-render-util0-dev \
            libxcb-util-dev \
            libxcb-xinerama0-dev \
            libxcb-xkb-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxcursor-dev

      - name: Install Conan
        run: |
          pip3 install conan
          conan profile detect --force

      - name: Install Conan dependencies
        run: |
          conan install . --output-folder=build/Release --build=missing -s build_type=Release -o system_qt=True

      - name: Configure CMake
        run: |
          TOOLCHAIN=$(find build/Release -name "conan_toolchain.cmake" -type f | head -1)
          cmake -S . -B build/Release \
            -DCMAKE_TOOLCHAIN_FILE="$TOOLCHAIN" \
            -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: |
          cmake --build build/Release --config Release --parallel

      - name: Package Linux release
        run: |
          # Create release directory structure
          mkdir -p nodo-linux-x86_64/bin
          mkdir -p nodo-linux-x86_64/lib
          
          # Copy binaries
          cp build/Release/nodo_studio/nodo_studio nodo-linux-x86_64/bin/
          cp build/Release/nodo_cli/nodo_cli nodo-linux-x86_64/bin/
          
          # Copy all shared library dependencies (Qt + others)
          # Get all dependencies and copy them
          for binary in build/Release/nodo_studio/nodo_studio build/Release/nodo_cli/nodo_cli; do
            ldd "$binary" | grep "=> /" | awk '{print $3}' | while read lib; do
              # Skip system libraries that should be on target system
              if [[ ! "$lib" =~ ^/lib/x86_64-linux-gnu/(libc\.|libm\.|libpthread\.|libdl\.|librt\.) ]] && \
                 [[ ! "$lib" =~ ^/usr/lib/x86_64-linux-gnu/(libstdc\+\+\.|libgcc_s\.) ]]; then
                cp -Ln "$lib" nodo-linux-x86_64/lib/ 2>/dev/null || true
              fi
            done
          done
          
          # Create launcher script that sets LD_LIBRARY_PATH
          cat > nodo-linux-x86_64/nodo_studio << 'EOF'
          #!/bin/bash
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          export LD_LIBRARY_PATH="$SCRIPT_DIR/lib:$LD_LIBRARY_PATH"
          exec "$SCRIPT_DIR/bin/nodo_studio" "$@"
          EOF
          chmod +x nodo-linux-x86_64/nodo_studio
          
          cat > nodo-linux-x86_64/nodo_cli << 'EOF'
          #!/bin/bash
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          export LD_LIBRARY_PATH="$SCRIPT_DIR/lib:$LD_LIBRARY_PATH"
          exec "$SCRIPT_DIR/bin/nodo_cli" "$@"
          EOF
          chmod +x nodo-linux-x86_64/nodo_cli
          
          # Create README
          cat > nodo-linux-x86_64/README.txt << 'EOF'
          Nodo - Node-based 3D Modeling Tool
          
          To run:
            ./nodo_studio    # Launch GUI application
            ./nodo_cli       # Run CLI tool
          
          Requirements:
            - Linux x86_64
            - OpenGL 3.3+ compatible graphics
          EOF
          
          # Create tarball
          tar -czf nodo-linux-x86_64.tar.gz nodo-linux-x86_64/

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: nodo-linux-x86_64
          path: nodo-linux-x86_64.tar.gz

  build-windows:
    runs-on: windows-2022

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Conan
        run: |
          pip install conan
          conan profile detect --force

      - name: Install Conan dependencies
        run: |
          conan install . --output-folder=build/Release --build=missing -s build_type=Release -s compiler.cppstd=20

      - name: Configure CMake
        run: |
          $toolchain = Get-ChildItem -Path build/Release -Filter "conan_toolchain.cmake" -Recurse | Select-Object -First 1 -ExpandProperty FullName
          cmake -S . -B build/Release `
            -DCMAKE_TOOLCHAIN_FILE="$toolchain" `
            -DCMAKE_BUILD_TYPE=Release `
            -G "Visual Studio 17 2022" `
            -A x64

      - name: Build
        run: |
          cmake --build build/Release --config Release --parallel

      - name: Package Windows
        run: |
          # Create package directory
          New-Item -ItemType Directory -Path nodo-windows-x64 -Force
          
          # Copy executables
          Copy-Item build/Release/nodo_studio/Release/nodo_studio.exe nodo-windows-x64/
          Copy-Item build/Release/nodo_cli/Release/nodo_cli.exe nodo-windows-x64/
          
          # Find Qt installation from Conan
          Write-Host "Searching for Qt DLLs in Conan packages..."
          $qtPath = Get-ChildItem -Path "$env:USERPROFILE\.conan2\p" -Directory -Recurse -Filter "bin" -ErrorAction SilentlyContinue | 
                    Where-Object { $_.FullName -like "*qt*" } | 
                    Select-Object -First 1
          
          if ($qtPath) {
            Write-Host "Found Qt bin directory: $($qtPath.FullName)"
            # Copy all Qt DLLs
            Get-ChildItem -Path $qtPath.FullName -Filter "Qt6*.dll" | ForEach-Object {
              Write-Host "Copying $_"
              Copy-Item $_.FullName nodo-windows-x64/ -Force
            }
            # Copy other DLLs from Qt bin (like opengl32sw.dll)
            Get-ChildItem -Path $qtPath.FullName -Filter "*.dll" | Where-Object { $_.Name -notlike "Qt6*" } | ForEach-Object {
              Write-Host "Copying $_"
              Copy-Item $_.FullName nodo-windows-x64/ -Force -ErrorAction SilentlyContinue
            }
          } else {
            Write-Host "WARNING: Qt bin directory not found in Conan packages"
          }
          
          # Find and copy other Conan dependency DLLs
          Write-Host "Searching for other dependency DLLs..."
          Get-ChildItem -Path "$env:USERPROFILE\.conan2\p" -Directory -Recurse -Filter "bin" -ErrorAction SilentlyContinue |
            Where-Object { $_.FullName -notlike "*qt*" } | ForEach-Object {
              Get-ChildItem -Path $_.FullName -Filter "*.dll" -ErrorAction SilentlyContinue | ForEach-Object {
                Write-Host "Copying $($_.Name)"
                Copy-Item $_.FullName nodo-windows-x64/ -Force -ErrorAction SilentlyContinue
              }
            }
          
          # Also copy any DLLs in the build output directories
          Get-ChildItem -Path "build/Release/nodo_studio/Release" -Filter "*.dll" -ErrorAction SilentlyContinue | ForEach-Object {
            Copy-Item $_.FullName nodo-windows-x64/ -Force
          }
          Get-ChildItem -Path "build/Release/nodo_cli/Release" -Filter "*.dll" -ErrorAction SilentlyContinue | ForEach-Object {
            Copy-Item $_.FullName nodo-windows-x64/ -Force
          }
          
          # List what we collected
          Write-Host "`nCollected DLLs:"
          Get-ChildItem -Path nodo-windows-x64 -Filter "*.dll" | ForEach-Object { Write-Host "  $($_.Name)" }
          
          # Create README
          @"
          Nodo - Node-based 3D Modeling Tool
          
          To run:
            Double-click nodo_studio.exe - Launch GUI application
            nodo_cli.exe - Run CLI tool from command prompt
          
          Requirements:
            - Windows 10/11 x64
            - Visual C++ Redistributable 2022 (should be included)
            - OpenGL 3.3+ compatible graphics
          "@ | Out-File -FilePath nodo-windows-x64/README.txt -Encoding ASCII
          
          # Create zip
          Compress-Archive -Path nodo-windows-x64/* -DestinationPath nodo-windows-x64.zip

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: nodo-windows-x64
          path: nodo-windows-x64.zip

  create-release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/nodo-linux-x86_64/nodo-linux-x86_64.tar.gz
            artifacts/nodo-windows-x64/nodo-windows-x64.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
