name: Release

on:
  push:
    tags:
      - 'v*'  # Triggers on tags like v0.1.0, v1.0.0, etc.

jobs:
  build-linux:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            pkg-config \
            python3-pip \
            qt6-base-dev \
            libqt6svg6-dev \
            libqt6concurrent6 \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libx11-dev \
            libxext-dev \
            libxfixes-dev \
            libxi-dev \
            libxrender-dev \
            libxcb1-dev \
            libxcb-glx0-dev \
            libxcb-keysyms1-dev \
            libxcb-image0-dev \
            libxcb-shm0-dev \
            libxcb-icccm4-dev \
            libxcb-sync-dev \
            libxcb-xfixes0-dev \
            libxcb-shape0-dev \
            libxcb-randr0-dev \
            libxcb-render-util0-dev \
            libxcb-util-dev \
            libxcb-xinerama0-dev \
            libxcb-xkb-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxcursor-dev

      - name: Install Conan
        run: |
          pip3 install conan
          conan profile detect --force

      - name: Install Conan dependencies
        run: |
          conan install . --output-folder=build/Release --build=missing -s build_type=Release -o system_qt=True

      - name: Configure CMake
        run: |
          TOOLCHAIN=$(find build/Release -name "conan_toolchain.cmake" -type f | head -1)
          cmake -S . -B build/Release \
            -DCMAKE_TOOLCHAIN_FILE="$TOOLCHAIN" \
            -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: |
          cmake --build build/Release --config Release --parallel

      - name: Package Linux AppImage
        run: |
          # Create AppDir structure
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/lib
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          
          # Copy binaries
          cp build/Release/nodo_studio/nodo_studio AppDir/usr/bin/
          cp build/Release/nodo_cli/nodo_cli AppDir/usr/bin/
          
          # Copy Qt libraries and dependencies
          ldd build/Release/nodo_studio/nodo_studio | grep "=> /" | awk '{print $3}' | xargs -I '{}' cp -v '{}' AppDir/usr/lib/ || true
          
          # Create desktop file
          cat > AppDir/usr/share/applications/nodo.desktop << EOF
          [Desktop Entry]
          Type=Application
          Name=Nodo
          Exec=nodo_studio
          Icon=nodo
          Categories=Graphics;3DGraphics;
          EOF
          
          # Copy icon (if exists)
          if [ -f nodo_studio/resources/logos/nodo_logo_256.png ]; then
            cp nodo_studio/resources/logos/nodo_logo_256.png AppDir/usr/share/icons/hicolor/256x256/apps/nodo.png
          fi
          
          # Create tarball
          tar -czf nodo-linux-x86_64.tar.gz -C build/Release nodo_studio/nodo_studio nodo_cli/nodo_cli

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: nodo-linux-x86_64
          path: nodo-linux-x86_64.tar.gz

  build-windows:
    runs-on: windows-2022

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Conan
        run: |
          pip install conan
          conan profile detect --force

      - name: Install Conan dependencies
        run: |
          conan install . --output-folder=build/Release --build=missing -s build_type=Release -s compiler.cppstd=20

      - name: Configure CMake
        run: |
          $toolchain = Get-ChildItem -Path build/Release -Filter "conan_toolchain.cmake" -Recurse | Select-Object -First 1 -ExpandProperty FullName
          cmake -S . -B build/Release `
            -DCMAKE_TOOLCHAIN_FILE="$toolchain" `
            -DCMAKE_BUILD_TYPE=Release `
            -G "Visual Studio 17 2022" `
            -A x64

      - name: Build
        run: |
          cmake --build build/Release --config Release --parallel

      - name: Package Windows
        run: |
          # Create package directory
          New-Item -ItemType Directory -Path nodo-windows-x64 -Force
          
          # Copy executables
          Copy-Item build/Release/nodo_studio/Release/nodo_studio.exe nodo-windows-x64/
          Copy-Item build/Release/nodo_cli/Release/nodo_cli.exe nodo-windows-x64/
          
          # Copy Qt DLLs and dependencies (Conan should have them in build/Release)
          Get-ChildItem -Path build/Release -Filter "*.dll" -Recurse | ForEach-Object {
            Copy-Item $_.FullName nodo-windows-x64/ -ErrorAction SilentlyContinue
          }
          
          # Create zip
          Compress-Archive -Path nodo-windows-x64/* -DestinationPath nodo-windows-x64.zip

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: nodo-windows-x64
          path: nodo-windows-x64.zip

  create-release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/nodo-linux-x86_64/nodo-linux-x86_64.tar.gz
            artifacts/nodo-windows-x64/nodo-windows-x64.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
