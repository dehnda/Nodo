name: Release

on:
  push:
    tags:
      - 'v*'  # Triggers on tags like v0.1.0, v1.0.0, etc.

jobs:
  build-linux:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            pkg-config \
            python3-pip \
            qt6-base-dev \
            libqt6svg6-dev \
            libqt6concurrent6 \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libx11-dev \
            libxext-dev \
            libxfixes-dev \
            libxi-dev \
            libxrender-dev \
            libxcb1-dev \
            libxcb-glx0-dev \
            libxcb-keysyms1-dev \
            libxcb-image0-dev \
            libxcb-shm0-dev \
            libxcb-icccm4-dev \
            libxcb-sync-dev \
            libxcb-xfixes0-dev \
            libxcb-shape0-dev \
            libxcb-randr0-dev \
            libxcb-render-util0-dev \
            libxcb-util-dev \
            libxcb-xinerama0-dev \
            libxcb-xkb-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxcursor-dev

      - name: Install Conan
        run: |
          pip3 install conan
          conan profile detect --force

      - name: Install Conan dependencies
        run: |
          conan install . --output-folder=build/Release --build=missing -s build_type=Release -o system_qt=True

      - name: Configure  CMake
        run: |
          TOOLCHAIN=$(find build/Release -name "conan_toolchain.cmake" -type f | head -1)
          cmake -S . -B build/Release \
            -DCMAKE_TOOLCHAIN_FILE="$TOOLCHAIN" \
            -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: |
          cmake --build build/Release --config Release --parallel

      - name: Package Linux release
        run: |
          # Create release directory structure
          mkdir -p nodo-linux-x86_64/bin
          mkdir -p nodo-linux-x86_64/lib

          # Copy binaries
          cp build/Release/nodo_studio/nodo_studio nodo-linux-x86_64/bin/
          cp build/Release/nodo_cli/nodo_cli nodo-linux-x86_64/bin/

          # Copy all shared library dependencies (Qt + others)
          # Get all dependencies and copy them
          for binary in build/Release/nodo_studio/nodo_studio build/Release/nodo_cli/nodo_cli; do
            ldd "$binary" | grep "=> /" | awk '{print $3}' | while read lib; do
              # Skip system libraries that should be on target system
              if [[ ! "$lib" =~ ^/lib/x86_64-linux-gnu/(libc\.|libm\.|libpthread\.|libdl\.|librt\.) ]] && \
                 [[ ! "$lib" =~ ^/usr/lib/x86_64-linux-gnu/(libstdc\+\+\.|libgcc_s\.) ]]; then
                cp -Ln "$lib" nodo-linux-x86_64/lib/ 2>/dev/null || true
              fi
            done
          done

          # Create launcher script that sets LD_LIBRARY_PATH
          cat > nodo-linux-x86_64/nodo_studio << 'EOF'
          #!/bin/bash
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          export LD_LIBRARY_PATH="$SCRIPT_DIR/lib:$LD_LIBRARY_PATH"
          exec "$SCRIPT_DIR/bin/nodo_studio" "$@"
          EOF
          chmod +x nodo-linux-x86_64/nodo_studio

          cat > nodo-linux-x86_64/nodo_cli << 'EOF'
          #!/bin/bash
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          export LD_LIBRARY_PATH="$SCRIPT_DIR/lib:$LD_LIBRARY_PATH"
          exec "$SCRIPT_DIR/bin/nodo_cli" "$@"
          EOF
          chmod +x nodo-linux-x86_64/nodo_cli

          # Create README
          cat > nodo-linux-x86_64/README.txt << 'EOF'
          Nodo - Node-based 3D Modeling Tool

          To run:
            ./nodo_studio    # Launch GUI application
            ./nodo_cli       # Run CLI tool

          Requirements:
            - Linux x86_64
            - OpenGL 3.3+ compatible graphics
          EOF

          # Create tarball
          tar -czf nodo-linux-x86_64.tar.gz nodo-linux-x86_64/

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: nodo-linux-x86_64
          path: nodo-linux-x86_64.tar.gz

  build-windows:
    runs-on: windows-2022

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Conan
        run: |
          pip install conan
          conan profile detect --force

      - name: Install Conan dependencies
        run: |
          conan install . --output-folder=build/Release --build=missing -s build_type=Release -s compiler.cppstd=20 -o system_qt=False

      - name: Configure CMake
        run: |
          $toolchain = Get-ChildItem -Path build/Release -Filter "conan_toolchain.cmake" -Recurse | Select-Object -First 1 -ExpandProperty FullName
          cmake -S . -B build/Release `
            -DCMAKE_TOOLCHAIN_FILE="$toolchain" `
            -DCMAKE_BUILD_TYPE=Release `
            -G "Visual Studio 17 2022" `
            -A x64

      - name: Build
        run: |
          cmake --build build/Release --config Release --parallel

      - name: Package Windows
        run: |
          # Create package directory
          New-Item -ItemType Directory -Path nodo-windows-x64 -Force

          # Copy executables
          Copy-Item build/Release/nodo_studio/Release/nodo_studio.exe nodo-windows-x64/
          Copy-Item build/Release/nodo_cli/Release/nodo_cli.exe nodo-windows-x64/

          # Find Qt installation from Conan cache
          $qtBinPath = Get-ChildItem -Path "$env:USERPROFILE\.conan2\p" -Filter "qt*" -Directory -Recurse -ErrorAction SilentlyContinue |
              Where-Object { (Test-Path "$($_.FullName)\bin\windeployqt.exe") -or (Test-Path "$($_.FullName)\p\bin\windeployqt.exe") } |
              Select-Object -First 1

          # Try different possible paths in Conan cache structure
          $windeployqt = $null
          $qtBinDir = $null

          # Search for windeployqt in Conan cache
          $windeployqtPaths = Get-ChildItem -Path "$env:USERPROFILE\.conan2\p" -Filter "windeployqt.exe" -Recurse -ErrorAction SilentlyContinue
          if ($windeployqtPaths) {
              $windeployqt = $windeployqtPaths[0].FullName
              $qtBinDir = Split-Path $windeployqt -Parent
              Write-Host "Found windeployqt at: $windeployqt"
              Write-Host "Qt bin directory: $qtBinDir"
          }

          if ($windeployqt -and (Test-Path $windeployqt)) {
              Write-Host "Using windeployqt to deploy Qt dependencies..."

              # Add Qt bin directory to PATH so windeployqt can find Qt DLLs
              $env:PATH = "$qtBinDir;$env:PATH"

              # Run windeployqt on the main executable
              & $windeployqt --release --no-translations --no-system-d3d-compiler --no-opengl-sw nodo-windows-x64/nodo_studio.exe

              Write-Host "windeployqt completed"
          } else {
              Write-Host "windeployqt not found, manually copying Qt DLLs..."

              # Fallback: manually find and copy Qt DLLs from Conan cache
              $qtDlls = @(
                  "Qt6Core.dll",
                  "Qt6Gui.dll",
                  "Qt6Widgets.dll",
                  "Qt6Svg.dll",
                  "Qt6Concurrent.dll",
                  "Qt6OpenGL.dll",
                  "Qt6OpenGLWidgets.dll"
              )

              foreach ($dll in $qtDlls) {
                  $found = Get-ChildItem -Path "$env:USERPROFILE\.conan2\p" -Filter $dll -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
                  if ($found) {
                      Write-Host "Found $dll at: $($found.FullName)"
                      Copy-Item $found.FullName nodo-windows-x64/ -Force
                  } else {
                      Write-Host "WARNING: Could not find $dll"
                  }
              }

              # Copy Qt plugins (required for Qt to work)
              $pluginTypes = @("platforms", "styles", "imageformats", "iconengines")
              foreach ($pluginType in $pluginTypes) {
                  $pluginDir = Get-ChildItem -Path "$env:USERPROFILE\.conan2\p" -Filter $pluginType -Directory -Recurse -ErrorAction SilentlyContinue |
                      Where-Object { $_.FullName -match "plugins" } | Select-Object -First 1
                  if ($pluginDir) {
                      Write-Host "Found $pluginType plugins at: $($pluginDir.FullName)"
                      New-Item -ItemType Directory -Path "nodo-windows-x64/$pluginType" -Force | Out-Null
                      Copy-Item "$($pluginDir.FullName)\*.dll" "nodo-windows-x64/$pluginType/" -Force -ErrorAction SilentlyContinue
                  }
              }
          }

          # Copy other non-Qt DLL dependencies from Conan cache
          Write-Host "`nSearching for other dependencies..."

          # Use dumpbin to find dependencies
          $vctools = vswhere -latest -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath
          $dumpbin = Get-ChildItem -Path "$vctools\VC\Tools\MSVC\*\bin\Hostx64\x64\dumpbin.exe" -ErrorAction SilentlyContinue | Select-Object -First 1

          if ($dumpbin) {
              $output = & $dumpbin.FullName /DEPENDENTS nodo-windows-x64/nodo_studio.exe 2>&1
              $dlls = $output | Select-String "\.dll" | ForEach-Object {
                  if ($_.Line.Trim() -match "^\s*(\S+\.dll)") {
                      $matches[1]
                  }
              }

              # Search paths for non-Qt DLLs
              $searchPaths = @(
                  "build/Release/nodo_studio/Release",
                  "build/Release/nodo_cli/Release",
                  "$env:USERPROFILE\.conan2\p"
              )

              foreach ($dll in $dlls) {
                  # Skip system DLLs and Qt DLLs (already handled)
                  if ($dll -match "^(KERNEL32|USER32|GDI32|ADVAPI32|ole32|SHELL32|WS2_32|msvcrt|MSVCP|VCRUNTIME|api-ms-|Qt6)") {
                      continue
                  }

                  # Skip if already exists
                  if (Test-Path "nodo-windows-x64/$dll") {
                      continue
                  }

                  foreach ($searchPath in $searchPaths) {
                      $found = Get-ChildItem -Path $searchPath -Filter $dll -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
                      if ($found) {
                          Write-Host "Found $dll at: $($found.FullName)"
                          Copy-Item $found.FullName nodo-windows-x64/ -Force
                          break
                      }
                  }
              }
          }

          # List what we collected
          Write-Host "`nCollected files:"
          Get-ChildItem -Path nodo-windows-x64 -Recurse | ForEach-Object {
              $relativePath = $_.FullName.Replace((Get-Location).Path + "\nodo-windows-x64\", "")
              Write-Host "  $relativePath"
          }

          # Create README
          @"
          Nodo - Node-based 3D Modeling Tool

          To run:
            Double-click nodo_studio.exe - Launch GUI application
            nodo_cli.exe - Run CLI tool from command prompt

          Requirements:
            - Windows 10/11 x64
            - Visual C++ Redistributable 2022 (may need to install from Microsoft)
            - OpenGL 3.3+ compatible graphics
          "@ | Out-File -FilePath nodo-windows-x64/README.txt -Encoding ASCII

          # Create zip
          Compress-Archive -Path nodo-windows-x64/* -DestinationPath nodo-windows-x64.zip

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: nodo-windows-x64
          path: nodo-windows-x64.zip

  create-release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/nodo-linux-x86_64/nodo-linux-x86_64.tar.gz
            artifacts/nodo-windows-x64/nodo-windows-x64.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
